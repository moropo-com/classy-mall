---
name: Moropo Deploy and Test
on: [pull_request]
jobs:
  Create:
    runs-on: ubuntu-latest
    steps:
      - name: Set up repository
        uses: actions/checkout@v2

      - name: Set up Node
        uses: actions/setup-node@v1
        with:
          node-version: 14.x

      - name: Set up Expo
        uses: expo/expo-github-action@v5
        with:
          expo-cache: true
          expo-version: 4.x
          expo-token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: yarn install

      - name: Publish to Expo & Create a QR code
        uses: expo/expo-preview-action@v1
        with:
          channel: moropo-test-${{ github.event.number }}
        id: preview

      - name: Split QR code URL
        uses: rishabhgupta/split-by@v1
        id: split
        with:
          string: '${{ steps.preview.outputs.EXPO_QR_CODE_URL }}'
          split-by: 'url='

      - name: Post/Edit Comment
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: Sending a test request to Moropo for commit ${{ github.sha }} using RC ${{ steps.split.outputs._1 }}.. please stand by.
          comment_includes: 'test request'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Test Request to Moropo
        run: |
          curl --request POST --fail \
          --url http://moropo.netlify.app/.netlify/functions/scheduleTestRun-background \
          --header 'content-type: application/json' \
          --header 'x-moropo-api-key: ${{ secrets.MOROPO_API_KEY }}' \
          --header 'x-moropo-app-id: ${{ secrets.MOROPO_APP_ID }}' \
          --header 'x-moropo-origin: ${{ github.event.pull_request.url}}' \
          --header 'x-moropo-expo-manifest-url: ${{ steps.split.outputs._1  }}'

      - name: Comment on Failure
        if: ${{ failure() }}
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: 'Something went wrong sending a test request to Moropo, for more information check the [CI Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).'
          comment_includes: 'test request'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on Success
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: 'A test request was successfully sent to Moropo for commit ${{ github.sha }} using RC ${{ steps.split_outputs._1 }}!'
          comment_includes: 'test request'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
